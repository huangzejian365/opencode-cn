name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Cache node_modules
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      run: npm ci
    
    - name: TypeScript check
      run: npx tsc --noEmit
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install and Build OpenCode Chinese Version
      run: |
        # --install 现在会自动完成：克隆源码、安装依赖、应用翻译、构建二进制
        bun run localize.ts --install
      shell: bash
      timeout-minutes: 20
    
    - name: Verify Installation
      run: |
        OPENCODE_DIR="$HOME/.opencode-cn/opencode"
        
        # 验证安装目录
        if [ ! -d "$OPENCODE_DIR" ]; then
          echo "✗ OpenCode 目录不存在"
          exit 1
        fi
        echo "✓ OpenCode 安装目录: $OPENCODE_DIR"
        
        # 验证中文翻译
        echo ""
        echo "=== 验证中文翻译 ==="
        if grep -r "选择认证方式\|API密钥\|选择提供商" "$OPENCODE_DIR" 2>/dev/null | head -3; then
          echo "✓ 中文翻译已成功应用"
        else
          echo "⚠ 未找到中文翻译内容"
        fi
        
        # 验证二进制文件
        echo ""
        echo "=== 验证二进制文件 ==="
        BINARY="$OPENCODE_DIR/packages/opencode/node_modules/opencode-linux-x64/bin/opencode"
        if [ -f "$BINARY" ]; then
          echo "✓ 二进制文件存在: $BINARY"
          "$BINARY" --version
          echo "✓ OpenCode 运行成功！"
        else
          echo "✗ 二进制文件不存在"
          exit 1
        fi
      shell: bash